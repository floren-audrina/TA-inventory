import{s as l}from"./db_conn-Cc8gtU8M.js";const W="data:text/javascript;base64,aW1wb3J0IHsgbG9nb3V0IH0gZnJvbSAnLi9hdXRoLmpzJzsNCg0KLy8gU2lkZWJhciB0b2dnbGUgZnVuY3Rpb25hbGl0eQ0KY29uc3Qgc2lkZWJhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzaWRlYmFyJyk7DQpjb25zdCBtZW51VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdG9nZ2xlJyk7DQoNCmlmIChtZW51VG9nZ2xlICYmIHNpZGViYXIpIHsNCiAgICBtZW51VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gew0KICAgICAgICBzaWRlYmFyLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScpOw0KICAgIH0pOw0KDQogICAgLy8gQ2xvc2Ugc2lkZWJhciB3aGVuIGNsaWNraW5nIG91dHNpZGUNCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudCkgPT4gew0KICAgICAgICBpZiAoIXNpZGViYXIuY29udGFpbnMoZXZlbnQudGFyZ2V0KSAmJiAhbWVudVRvZ2dsZS5jb250YWlucyhldmVudC50YXJnZXQpKSB7DQogICAgICAgICAgICBzaWRlYmFyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOw0KICAgICAgICB9DQogICAgfSk7DQp9DQoNCmZ1bmN0aW9uIHNldHVwTG9nb3V0KCkgew0KICAgIGNvbnN0IGxvZ291dExpbmsgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9nb3V0LWxpbmsnKTsNCg0KICAgIGlmICghbG9nb3V0TGluaykgew0KICAgICAgICBjb25zb2xlLmVycm9yKCdMb2dvdXQgbGluayBub3QgZm91bmQhJyk7DQogICAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBsb2dvdXRMaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpID0+IHsNCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICBjb25zb2xlLmxvZygnTG9nb3V0IGNsaWNrZWQnKTsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIGF3YWl0IGxvZ291dCgpOw0KICAgICAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgICAgICAgY29uc29sZS5lcnJvcignTG9nb3V0IGZhaWxlZDonLCBlcnJvcik7DQogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9ICcvaW5kZXguaHRtbCc7DQogICAgICAgIH0NCiAgICB9KTsNCn0NCg0KZXhwb3J0IHsNCiAgICBzZXR1cExvZ291dA0KfQ==",A="/TA-inventory";function y(){return window.location.origin+A}async function v(){if(window.location.pathname.includes(`${A}/index.html`))return!0;const{data:{session:n},error:e}=await l.auth.getSession();return n?!0:(k(),!1)}function k(){localStorage.removeItem("sb_auth_token"),sessionStorage.removeItem("sb_auth_token"),window.location.href=`${y()}/index.html`}function V(){l.auth.onAuthStateChange(n=>{console.log("Auth state changed:",n),n==="SIGNED_OUT"&&k()})}async function h(n,e,t){const{data:a,error:o}=await l.from("produk_varian").select("jumlah_stok").eq("id",n).single();if(o)return console.error("Error fetching variant stock:",o),null;let i=a.jumlah_stok;t==="pembelian"||t==="penyesuaian_masuk"?i+=e:(t==="penjualan"||t==="penyesuaian_keluar")&&(i-=e);const{error:s}=await l.from("produk_varian").update({jumlah_stok:i}).eq("id",n);return s?(console.error("Error updating variant stock:",s),null):i}async function _(n,e){const{data:t}=await l.from("riwayat_stok").select("id, qty, stok_sisa, harga, tanggal").eq("id_varian",n).eq("tipe_riwayat","pembelian").gt("stok_sisa",0).order("tanggal",{ascending:!0}).limit(100);let a=e,o=0;const i=[],s=[];for(const r of t){if(a<=0)break;const c=Math.min(a,r.stok_sisa);o+=c*r.harga,a-=c,i.push({id:r.id,newRemaining:r.stok_sisa-c}),s.push({usedQty:c,purchasePrice:r.harga,purchaseDate:r.tanggal})}return i.length>0&&await l.rpc("batch_update_remaining",{updates:i.map(r=>({id:r.id,remaining:r.newRemaining}))}),{averageHpp:o/e,consumptionRecords:s,hasPartialConsumption:s.length>1}}async function S({variantId:n=null,type:e=null,id:t=null,quantity:a=null,price:o=null,date:i=new Date().toISOString()}){try{if(!n||!e||a===null)throw new Error("Missing required parameters");const{data:s,error:r}=await l.from("produk_varian").select("jumlah_stok").eq("id",n).single();if(r)throw r;const c=s.jumlah_stok;if(e==="pembelian"||e==="penyesuaian_masuk"){let u=c;if(e==="penyesuaian_masuk"&&(u=await h(n,a,e),u===null))throw new Error("Failed to update variant stock");const{data:g,error:d}=await l.from("riwayat_stok").insert([{id_varian:n,tipe_riwayat:e,qty:a,stok_sisa:a,saldo:u,harga:o,hpp:null,tanggal:i,id_referensi:t}]).select();if(d)throw d;return{success:!0,newStock:u,records:g,isMultiRecord:!1}}if(e==="penjualan"||e==="penyesuaian_keluar"){const{averageHpp:u,consumptionRecords:g,hasPartialConsumption:d}=await _(n,a);if(d){const m=[];let I=c;for(const C of g)I-=C.usedQty,m.push({id_varian:n,tipe_riwayat:e,qty:C.usedQty,stok_sisa:null,saldo:I,harga:o,hpp:C.purchasePrice,tanggal:i,id_referensi:t});const w=await h(n,a,e);if(w===null)throw new Error("Failed to update variant stock");const{error:f}=await l.from("riwayat_stok").insert(m);if(f)throw f;return{success:!0,newStock:w,records:m,isMultiRecord:!0}}const p=await h(n,a,e);if(p===null)throw new Error("Failed to update variant stock");const{data:Z,error:b}=await l.from("riwayat_stok").insert([{id_varian:n,tipe_riwayat:e,qty:a,stok_sisa:null,saldo:p,harga:o,hpp:u,tanggal:i,id_referensi:t}]).select();if(b)throw b;return{success:!0,newStock:p,records:Z,isMultiRecord:!1}}throw new Error("Invalid transaction type")}catch(s){throw console.error("Error in processEntry:",s),s}}async function G(){try{const n=new Date,e=new Date(n),t=new Date(n);e.setMonth(e.getMonth()-1),t.setMonth(t.getMonth()-3);const{data:a,error:o}=await l.from("pesanan_pembelian").select(`
                id,
                tanggal_diterima,
                supplier: id_supplier(perusahaan, cp)
            `).eq("status_pesanan","diterima").lt("tanggal_diterima",e.toISOString().split("T")[0]);if(o)throw o;return(a||[]).map(s=>{const r=new Date(s.tanggal_diterima);let c="1_bulan";return r<t&&(c="3_bulan"),{...s,overdueType:c}})}catch(n){return console.error("Error checking unpaid orders:",n),[]}}async function B(){const n=document.getElementById("unpaidBannerRow"),e=document.getElementById("unpaidBanner");if(!n||!e){console.warn("[WARN] unpaidBanner or unpaidBannerRow container not found.");return}e.innerHTML="",n.style.display="none";const t=await G();if(t.length===0)return;n.style.display="flex";const a=document.createElement("div");a.className="unpaid-notice-banner alert alert-danger d-flex justify-content-between align-items-center mb-0";let o="";const i=t.filter(r=>r.overdueType==="1_bulan").length,s=t.filter(r=>r.overdueType==="3_bulan").length;s>0&&(o+=`⚠️ ${s} pesanan sudah lewat 3 bulan dan belum dibayar. `),i>0&&(o+=`${i} pesanan sudah lewat 1 bulan dan belum dibayar. `),o+='<a href="/pembelian.html" style="color: #a30000; text-decoration: underline;">Lihat daftar pesanan</a>',a.innerHTML=`
        <div class="container-fluid d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span>${o}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `,e.appendChild(a),a.querySelector(".btn-close").addEventListener("click",()=>{a.remove(),e.hasChildNodes()||(n.style.display="none")})}export{v as c,B as d,V as i,W as n,S as p,h as u};
