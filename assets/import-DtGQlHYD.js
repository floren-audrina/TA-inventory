import{s as l}from"./db_conn-Cc8gtU8M.js";async function g(a,r,n){const{data:e,error:i}=await l.from("produk_varian").select("jumlah_stok").eq("id",a).single();if(i)return console.error("Error fetching variant stock:",i),null;let s=e.jumlah_stok;n==="pembelian"||n==="penyesuaian_masuk"?s+=r:(n==="penjualan"||n==="penyesuaian_keluar")&&(s-=r);const{error:o}=await l.from("produk_varian").update({jumlah_stok:s}).eq("id",a);return o?(console.error("Error updating variant stock:",o),null):s}async function v(a,r){const{data:n}=await l.from("riwayat_stok").select("id, qty, stok_sisa, harga, tanggal").eq("id_varian",a).eq("tipe_riwayat","pembelian").gt("stok_sisa",0).order("tanggal",{ascending:!0}).limit(100);let e=r,i=0;const s=[],o=[];for(const t of n){if(e<=0)break;const c=Math.min(e,t.stok_sisa);i+=c*t.harga,e-=c,s.push({id:t.id,newRemaining:t.stok_sisa-c}),o.push({usedQty:c,purchasePrice:t.harga,purchaseDate:t.tanggal})}return s.length>0&&await l.rpc("batch_update_remaining",{updates:s.map(t=>({id:t.id,remaining:t.newRemaining}))}),{averageHpp:i/r,consumptionRecords:o,hasPartialConsumption:o.length>1}}async function b({variantId:a=null,type:r=null,id:n=null,quantity:e=null,price:i=null,date:s=new Date().toISOString()}){try{if(!a||!r||e===null)throw new Error("Missing required parameters");const{data:o,error:t}=await l.from("produk_varian").select("jumlah_stok").eq("id",a).single();if(t)throw t;const c=o.jumlah_stok;if(r==="pembelian"||r==="penyesuaian_masuk"){let u=c;if(r==="penyesuaian_masuk"&&(u=await g(a,e,r),u===null))throw new Error("Failed to update variant stock");const{data:p,error:d}=await l.from("riwayat_stok").insert([{id_varian:a,tipe_riwayat:r,qty:e,stok_sisa:e,saldo:u,harga:i,hpp:null,tanggal:s,id_referensi:n}]).select();if(d)throw d;return{success:!0,newStock:u,records:p,isMultiRecord:!1}}if(r==="penjualan"||r==="penyesuaian_keluar"){const{averageHpp:u,consumptionRecords:p,hasPartialConsumption:d}=await v(a,e);if(d){const f=[];let _=c;for(const w of p)_-=w.usedQty,f.push({id_varian:a,tipe_riwayat:r,qty:w.usedQty,stok_sisa:null,saldo:_,harga:i,hpp:w.purchasePrice,tanggal:s,id_referensi:n});const m=await g(a,e,r);if(m===null)throw new Error("Failed to update variant stock");const{error:E}=await l.from("riwayat_stok").insert(f);if(E)throw E;return{success:!0,newStock:m,records:f,isMultiRecord:!0}}const h=await g(a,e,r);if(h===null)throw new Error("Failed to update variant stock");const{data:S,error:k}=await l.from("riwayat_stok").insert([{id_varian:a,tipe_riwayat:r,qty:e,stok_sisa:null,saldo:h,harga:i,hpp:u,tanggal:s,id_referensi:n}]).select();if(k)throw k;return{success:!0,newStock:h,records:S,isMultiRecord:!1}}throw new Error("Invalid transaction type")}catch(o){throw console.error("Error in processEntry:",o),o}}export{b as p,g as u};
