import{s as c}from"./db_conn-Cc8gtU8M.js";import{s as v}from"./navbar-Cao3KjDQ.js";async function g(e,a,t){const{data:n,error:o}=await c.from("produk_varian").select("jumlah_stok").eq("id",e).single();if(o)return console.error("Error fetching variant stock:",o),null;let i=n.jumlah_stok;t==="pembelian"||t==="penyesuaian_masuk"?i+=a:(t==="penjualan"||t==="penyesuaian_keluar")&&(i-=a);const{error:s}=await c.from("produk_varian").update({jumlah_stok:i}).eq("id",e);return s?(console.error("Error updating variant stock:",s),null):i}async function E(e,a){const{data:t}=await c.from("riwayat_stok").select("id, qty, stok_sisa, harga, tanggal").eq("id_varian",e).eq("tipe_riwayat","pembelian").gt("stok_sisa",0).order("tanggal",{ascending:!0}).limit(100);let n=a,o=0;const i=[],s=[];for(const r of t){if(n<=0)break;const l=Math.min(n,r.stok_sisa);o+=l*r.harga,n-=l,i.push({id:r.id,newRemaining:r.stok_sisa-l}),s.push({usedQty:l,purchasePrice:r.harga,purchaseDate:r.tanggal})}return i.length>0&&await c.rpc("batch_update_remaining",{updates:i.map(r=>({id:r.id,remaining:r.newRemaining}))}),{averageHpp:o/a,consumptionRecords:s,hasPartialConsumption:s.length>1}}async function x({variantId:e=null,type:a=null,id:t=null,quantity:n=null,price:o=null,date:i=new Date().toISOString()}){try{if(!e||!a||n===null)throw new Error("Missing required parameters");const{data:s,error:r}=await c.from("produk_varian").select("jumlah_stok").eq("id",e).single();if(r)throw r;const l=s.jumlah_stok;if(a==="pembelian"||a==="penyesuaian_masuk"){let u=l;if(a==="penyesuaian_masuk"&&(u=await g(e,n,a),u===null))throw new Error("Failed to update variant stock");const{data:p,error:d}=await c.from("riwayat_stok").insert([{id_varian:e,tipe_riwayat:a,qty:n,stok_sisa:n,saldo:u,harga:o,hpp:null,tanggal:i,id_referensi:t}]).select();if(d)throw d;return{success:!0,newStock:u,records:p,isMultiRecord:!1}}if(a==="penjualan"||a==="penyesuaian_keluar"){const{averageHpp:u,consumptionRecords:p,hasPartialConsumption:d}=await E(e,n);if(d){const m=[];let _=l;for(const f of p)_-=f.usedQty,m.push({id_varian:e,tipe_riwayat:a,qty:f.usedQty,stok_sisa:null,saldo:_,harga:o,hpp:f.purchasePrice,tanggal:i,id_referensi:t});const k=await g(e,n,a);if(k===null)throw new Error("Failed to update variant stock");const{error:b}=await c.from("riwayat_stok").insert(m);if(b)throw b;return{success:!0,newStock:k,records:m,isMultiRecord:!0}}const h=await g(e,n,a);if(h===null)throw new Error("Failed to update variant stock");const{data:y,error:w}=await c.from("riwayat_stok").insert([{id_varian:e,tipe_riwayat:a,qty:n,stok_sisa:null,saldo:h,harga:o,hpp:u,tanggal:i,id_referensi:t}]).select();if(w)throw w;return{success:!0,newStock:h,records:y,isMultiRecord:!1}}throw new Error("Invalid transaction type")}catch(s){throw console.error("Error in processEntry:",s),s}}async function M(){try{const e=new Date,a=new Date(e),t=new Date(e);a.setMonth(a.getMonth()-1),t.setMonth(t.getMonth()-3);const{data:n,error:o}=await c.from("pesanan_pembelian").select(`
                id,
                tanggal_diterima,
                supplier: id_supplier(perusahaan, cp)
            `).eq("status_pesanan","diterima").lt("tanggal_diterima",a.toISOString().split("T")[0]);if(o)throw o;return(n||[]).map(s=>{const r=new Date(s.tanggal_diterima);let l="1_bulan";return r<t&&(l="3_bulan"),{...s,overdueType:l}})}catch(e){return console.error("Error checking unpaid orders:",e),[]}}async function T(){const e=document.getElementById("unpaidBannerRow"),a=document.getElementById("unpaidBanner");if(!e||!a){console.warn("[WARN] unpaidBanner or unpaidBannerRow container not found.");return}a.innerHTML="",e.style.display="none";const t=await M();if(t.length===0)return;e.style.display="flex";const n=document.createElement("div");n.className="unpaid-notice-banner alert alert-danger d-flex justify-content-between align-items-center mb-0";let o="";const i=t.filter(r=>r.overdueType==="1_bulan").length,s=t.filter(r=>r.overdueType==="3_bulan").length;s>0&&(o+=`⚠️ ${s} pesanan sudah lewat 3 bulan dan belum dibayar. `),i>0&&(o+=`${i} pesanan sudah lewat 1 bulan dan belum dibayar. `),o+='<a href="/pembelian.html" style="color: #a30000; text-decoration: underline;">Lihat daftar pesanan</a>',n.innerHTML=`
        <div class="container-fluid d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span>${o}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `,a.appendChild(n),n.querySelector(".btn-close").addEventListener("click",()=>{n.remove(),a.hasChildNodes()||(e.style.display="none")})}async function B(){try{const e=await fetch("/navbar.html");console.log("navbar",e);const a=await e.text();document.getElementById("navbar").innerHTML=a,await new Promise(t=>requestAnimationFrame(t)),v()}catch(e){console.error("Error loading navbar:",e)}}export{T as d,B as l,x as p,g as u};
