import{s as l}from"./db_conn-Cc8gtU8M.js";const S="/TA-inventory";function k(){return window.location.origin+S}async function D(){if(window.location.pathname.includes(`${S}/index.html`))return!0;const{data:{session:e},error:t}=await l.auth.getSession();return e?!0:(L(),!1)}function L(){localStorage.removeItem("sb_auth_token"),sessionStorage.removeItem("sb_auth_token"),window.location.href=`${k()}/index.html`}async function x(){try{console.log("Attempting logout..."),localStorage.removeItem("sb_auth_token"),sessionStorage.removeItem("sb_auth_token");const{error:e}=await l.auth.signOut();if(e)throw e;console.log("Logout successful, redirecting..."),window.location.href=`${k()}/index.html`}catch(e){console.error("Logout failed:",e),window.location.href=`${k()}/index.html`}}function C(){l.auth.onAuthStateChange(e=>{console.log("Auth state changed:",e),e==="SIGNED_OUT"&&L()})}async function w(e,t,n){const{data:a,error:o}=await l.from("produk_varian").select("jumlah_stok").eq("id",e).single();if(o)return console.error("Error fetching variant stock:",o),null;let i=a.jumlah_stok;n==="pembelian"||n==="penyesuaian_masuk"?i+=t:(n==="penjualan"||n==="penyesuaian_keluar")&&(i-=t);const{error:s}=await l.from("produk_varian").update({jumlah_stok:i}).eq("id",e);return s?(console.error("Error updating variant stock:",s),null):i}async function T(e,t){const{data:n}=await l.from("riwayat_stok").select("id, qty, stok_sisa, harga, tanggal").eq("id_varian",e).eq("tipe_riwayat","pembelian").gt("stok_sisa",0).order("tanggal",{ascending:!0}).limit(100);let a=t,o=0;const i=[],s=[];for(const r of n){if(a<=0)break;const c=Math.min(a,r.stok_sisa);o+=c*r.harga,a-=c,i.push({id:r.id,newRemaining:r.stok_sisa-c}),s.push({usedQty:c,purchasePrice:r.harga,purchaseDate:r.tanggal})}return i.length>0&&await l.rpc("batch_update_remaining",{updates:i.map(r=>({id:r.id,remaining:r.newRemaining}))}),{averageHpp:o/t,consumptionRecords:s,hasPartialConsumption:s.length>1}}async function O({variantId:e=null,type:t=null,id:n=null,quantity:a=null,price:o=null,date:i=new Date().toISOString()}){try{if(!e||!t||a===null)throw new Error("Missing required parameters");const{data:s,error:r}=await l.from("produk_varian").select("jumlah_stok").eq("id",e).single();if(r)throw r;const c=s.jumlah_stok;if(t==="pembelian"||t==="penyesuaian_masuk"){let u=c;if(t==="penyesuaian_masuk"&&(u=await w(e,a,t),u===null))throw new Error("Failed to update variant stock");const{data:h,error:d}=await l.from("riwayat_stok").insert([{id_varian:e,tipe_riwayat:t,qty:a,stok_sisa:a,saldo:u,harga:o,hpp:null,tanggal:i,id_referensi:n}]).select();if(d)throw d;return{success:!0,newStock:u,records:h,isMultiRecord:!1}}if(t==="penjualan"||t==="penyesuaian_keluar"){const{averageHpp:u,consumptionRecords:h,hasPartialConsumption:d}=await T(e,a);if(d){const f=[];let y=c;for(const p of h)y-=p.usedQty,f.push({id_varian:e,tipe_riwayat:t,qty:p.usedQty,stok_sisa:null,saldo:y,harga:o,hpp:p.purchasePrice,tanggal:i,id_referensi:n});const v=await w(e,a,t);if(v===null)throw new Error("Failed to update variant stock");const{error:E}=await l.from("riwayat_stok").insert(f);if(E)throw E;return{success:!0,newStock:v,records:f,isMultiRecord:!0}}const m=await w(e,a,t);if(m===null)throw new Error("Failed to update variant stock");const{data:M,error:b}=await l.from("riwayat_stok").insert([{id_varian:e,tipe_riwayat:t,qty:a,stok_sisa:null,saldo:m,harga:o,hpp:u,tanggal:i,id_referensi:n}]).select();if(b)throw b;return{success:!0,newStock:m,records:M,isMultiRecord:!1}}throw new Error("Invalid transaction type")}catch(s){throw console.error("Error in processEntry:",s),s}}async function A(){try{const e=new Date,t=new Date(e),n=new Date(e);t.setMonth(t.getMonth()-1),n.setMonth(n.getMonth()-3);const{data:a,error:o}=await l.from("pesanan_pembelian").select(`
                id,
                tanggal_diterima,
                supplier: id_supplier(perusahaan, cp)
            `).eq("status_pesanan","diterima").lt("tanggal_diterima",t.toISOString().split("T")[0]);if(o)throw o;return(a||[]).map(s=>{const r=new Date(s.tanggal_diterima);let c="1_bulan";return r<n&&(c="3_bulan"),{...s,overdueType:c}})}catch(e){return console.error("Error checking unpaid orders:",e),[]}}async function P(){const e=document.getElementById("unpaidBannerRow"),t=document.getElementById("unpaidBanner");if(!e||!t){console.warn("[WARN] unpaidBanner or unpaidBannerRow container not found.");return}t.innerHTML="",e.style.display="none";const n=await A();if(n.length===0)return;e.style.display="flex";const a=document.createElement("div");a.className="unpaid-notice-banner alert alert-danger d-flex justify-content-between align-items-center mb-0";let o="";const i=n.filter(r=>r.overdueType==="1_bulan").length,s=n.filter(r=>r.overdueType==="3_bulan").length;s>0&&(o+=`⚠️ ${s} pesanan sudah lewat 3 bulan dan belum dibayar. `),i>0&&(o+=`${i} pesanan sudah lewat 1 bulan dan belum dibayar. `),o+='<a href="/pembelian.html" style="color: #a30000; text-decoration: underline;">Lihat daftar pesanan</a>',a.innerHTML=`
        <div class="container-fluid d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span>${o}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `,t.appendChild(a),a.querySelector(".btn-close").addEventListener("click",()=>{a.remove(),t.hasChildNodes()||(e.style.display="none")})}const g=document.getElementById("sidebar"),_=document.getElementById("menu-toggle");_&&g&&(_.addEventListener("click",()=>{g.classList.toggle("active")}),document.addEventListener("click",e=>{!g.contains(e.target)&&!_.contains(e.target)&&g.classList.remove("active")}));function B(){const e=document.getElementById("logout-link");if(!e){console.error("Logout link not found!");return}e.addEventListener("click",async t=>{t.preventDefault(),console.log("Logout clicked");try{await x()}catch(n){console.error("Logout failed:",n),window.location.href="/index.html"}})}async function H(){try{const e=await fetch("/navbar.html");console.log("navbar",e);const t=await e.text();document.getElementById("navbar").innerHTML=t,await new Promise(n=>requestAnimationFrame(n)),B()}catch(e){console.error("Error loading navbar:",e)}}export{D as c,P as d,C as i,H as l,O as p,w as u};
