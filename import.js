import{s as c}from"./db.js";const _="data:text/javascript;base64,aW1wb3J0IHsgbG9nb3V0IH0gZnJvbSAnQGF1dGgnOw0KDQovLyBTaWRlYmFyIHRvZ2dsZSBmdW5jdGlvbmFsaXR5DQpjb25zdCBzaWRlYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZGViYXInKTsNCmNvbnN0IG1lbnVUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVudS10b2dnbGUnKTsNCg0KaWYgKG1lbnVUb2dnbGUgJiYgc2lkZWJhcikgew0KICAgIG1lbnVUb2dnbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7DQogICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJyk7DQogICAgfSk7DQoNCiAgICAvLyBDbG9zZSBzaWRlYmFyIHdoZW4gY2xpY2tpbmcgb3V0c2lkZQ0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KSA9PiB7DQogICAgICAgIGlmICghc2lkZWJhci5jb250YWlucyhldmVudC50YXJnZXQpICYmICFtZW51VG9nZ2xlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHsNCiAgICAgICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7DQogICAgICAgIH0NCiAgICB9KTsNCn0NCg0KZnVuY3Rpb24gc2V0dXBMb2dvdXQoKSB7DQogICAgY29uc3QgbG9nb3V0TGluayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2dvdXQtbGluaycpOw0KDQogICAgaWYgKCFsb2dvdXRMaW5rKSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ0xvZ291dCBsaW5rIG5vdCBmb3VuZCEnKTsNCiAgICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIGxvZ291dExpbmsuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoZSkgPT4gew0KICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgIGNvbnNvbGUubG9nKCdMb2dvdXQgY2xpY2tlZCcpOw0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgYXdhaXQgbG9nb3V0KCk7DQogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdMb2dvdXQgZmFpbGVkOicsIGVycm9yKTsNCiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gJy9pbmRleC5odG1sJzsNCiAgICAgICAgfQ0KICAgIH0pOw0KfQ0KDQpleHBvcnQgew0KICAgIHNldHVwTG9nb3V0DQp9";async function C(a,n,t){const{data:e,error:s}=await c.from("produk_varian").select("jumlah_stok").eq("id",a).single();if(s)return console.error("Error fetching variant stock:",s),null;let i=e.jumlah_stok;t==="pembelian"||t==="penyesuaian_masuk"?i+=n:(t==="penjualan"||t==="penyesuaian_keluar")&&(i-=n);const{error:o}=await c.from("produk_varian").update({jumlah_stok:i}).eq("id",a);return o?(console.error("Error updating variant stock:",o),null):i}async function A(a,n){const{data:t}=await c.from("riwayat_stok").select("id, qty, stok_sisa, harga, tanggal").eq("id_varian",a).eq("tipe_riwayat","pembelian").gt("stok_sisa",0).order("tanggal",{ascending:!0}).limit(100);let e=n,s=0;const i=[],o=[];for(const r of t){if(e<=0)break;const l=Math.min(e,r.stok_sisa);s+=l*r.harga,e-=l,i.push({id:r.id,newRemaining:r.stok_sisa-l}),o.push({usedQty:l,purchasePrice:r.harga,purchaseDate:r.tanggal})}return i.length>0&&await c.rpc("batch_update_remaining",{updates:i.map(r=>({id:r.id,remaining:r.newRemaining}))}),{averageHpp:s/n,consumptionRecords:o,hasPartialConsumption:o.length>1}}async function v({variantId:a=null,type:n=null,id:t=null,quantity:e=null,price:s=null,date:i=new Date().toISOString()}){try{if(!a||!n||e===null)throw new Error("Missing required parameters");const{data:o,error:r}=await c.from("produk_varian").select("jumlah_stok").eq("id",a).single();if(r)throw r;const l=o.jumlah_stok;if(n==="pembelian"||n==="penyesuaian_masuk"){let d=l;if(n==="penyesuaian_masuk"&&(d=await C(a,e,n),d===null))throw new Error("Failed to update variant stock");const{data:u,error:g}=await c.from("riwayat_stok").insert([{id_varian:a,tipe_riwayat:n,qty:e,stok_sisa:e,saldo:d,harga:s,hpp:null,tanggal:i,id_referensi:t}]).select();if(g)throw g;return{success:!0,newStock:d,records:u,isMultiRecord:!1}}if(n==="penjualan"||n==="penyesuaian_keluar"){const{averageHpp:d,consumptionRecords:u,hasPartialConsumption:g}=await A(a,e);if(g){const b=[];let I=l;for(const m of u)I-=m.usedQty,b.push({id_varian:a,tipe_riwayat:n,qty:m.usedQty,stok_sisa:null,saldo:I,harga:s,hpp:m.purchasePrice,tanggal:i,id_referensi:t});const f=await C(a,e,n);if(f===null)throw new Error("Failed to update variant stock");const{error:w}=await c.from("riwayat_stok").insert(b);if(w)throw w;return{success:!0,newStock:f,records:b,isMultiRecord:!0}}const p=await C(a,e,n);if(p===null)throw new Error("Failed to update variant stock");const{data:k,error:h}=await c.from("riwayat_stok").insert([{id_varian:a,tipe_riwayat:n,qty:e,stok_sisa:null,saldo:p,harga:s,hpp:d,tanggal:i,id_referensi:t}]).select();if(h)throw h;return{success:!0,newStock:p,records:k,isMultiRecord:!1}}throw new Error("Invalid transaction type")}catch(o){throw console.error("Error in processEntry:",o),o}}async function y(){try{const a=new Date,n=new Date(a),t=new Date(a);n.setMonth(n.getMonth()-1),t.setMonth(t.getMonth()-3);const{data:e,error:s}=await c.from("pesanan_pembelian").select(`
                id,
                tanggal_diterima,
                supplier: id_supplier(perusahaan, cp)
            `).eq("status_pesanan","diterima").lt("tanggal_diterima",n.toISOString().split("T")[0]);if(s)throw s;return(e||[]).map(o=>{const r=new Date(o.tanggal_diterima);let l="1_bulan";return r<t&&(l="3_bulan"),{...o,overdueType:l}})}catch(a){return console.error("Error checking unpaid orders:",a),[]}}async function G(){const a=document.getElementById("unpaidBannerRow"),n=document.getElementById("unpaidBanner");if(!a||!n){console.warn("[WARN] unpaidBanner or unpaidBannerRow container not found.");return}n.innerHTML="",a.style.display="none";const t=await y();if(t.length===0)return;a.style.display="flex";const e=document.createElement("div");e.className="unpaid-notice-banner alert alert-danger d-flex justify-content-between align-items-center mb-0";let s="";const i=t.filter(r=>r.overdueType==="1_bulan").length,o=t.filter(r=>r.overdueType==="3_bulan").length;o>0&&(s+=`⚠️ ${o} pesanan sudah lewat 3 bulan dan belum dibayar. `),i>0&&(s+=`${i} pesanan sudah lewat 1 bulan dan belum dibayar. `),s+='<a href="/pembelian.html" style="color: #a30000; text-decoration: underline;">Lihat daftar pesanan</a>',e.innerHTML=`
        <div class="container-fluid d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span>${s}</span>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `,n.appendChild(e),e.querySelector(".btn-close").addEventListener("click",()=>{e.remove(),n.hasChildNodes()||(a.style.display="none")})}export{G as d,_ as n,v as p,C as u};
